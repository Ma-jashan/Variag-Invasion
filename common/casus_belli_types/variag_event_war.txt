final_battle_variags_cb = {
	group = event 

	combine_into_one = yes
	should_show_war_goal_subview = yes
	mutually_exclusive_titles = { always = yes }
	
	allowed_for_character = {
		NOT = {
			government_has_flag = government_is_feudal
			government_has_flag = government_is_tribal
			government_has_flag = government_is_republic 
			government_has_flag = government_is_theocracy 
			government_has_flag = government_is_clan 
			government_has_flag = government_is_mercenary
			government_has_flag = government_is_holy_order 
			government_has_flag = government_is_elven 
		}
		always = no
		
		scope:attacker = {		
			NOT = {
				has_culture = culture:wastelands
			}
		}
	}
	
	target_titles = all
	target_title_tier = all
	target_de_jure_regions_above = yes
	ignore_effect = change_title_holder
	
	war_name = "INVASION_WAR_NAME"
	war_name_base = "INVASION_WAR_NAME_BASE"
	cb_name = "INVASION_CB_NAME"
	
	on_declaration = {
		on_declared_war = yes
        scope:defender = {
                trigger_event = gondor.2101
        }
	}
	
	on_white_peace_desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:defender = { is_local_player = yes } }
				desc = invasion_war_white_peace_desc_defender
			}
			desc = invasion_war_white_peace_desc
		}
	}
	
	on_white_peace = {
		scope:attacker = { show_pow_release_message_effect = yes }

		# Prestige for the attacker's war allies
		add_from_contribution_attackers = {
			prestige = major_prestige_value
			opinion = {
				modifier = contributed_in_war
			}
		}

		# Prestige for the defender's war allies
		add_from_contribution_defenders = {
			prestige = major_prestige_value
			opinion = {
				modifier = contributed_in_war
			}
		}

		# Truce
		add_truce_white_peace_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}
	
	on_invalidated_desc = msg_invalidate_war_title

	on_defeat_desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:defender = { is_local_player = yes } }
				desc = invasion_war_white_peace_desc_defender
			}
			desc = invasion_war_white_peace_desc
		}
	}
	
	on_defeat = {
		# Legitimacy
		add_legitimacy_attacker_defeat_effect = yes

		scope:attacker = { show_pow_release_message_effect = yes }

		# Prestige loss for the attacker
		scope:attacker = {
			pay_short_term_gold = {
				gold = 5
				target = scope:defender
				yearly_income = yes
			}
			add_prestige = {
				value = massive_prestige_value
				multiply = -1.0
			}
		}
		
		setup_invasion_cb = {
			titles = target_titles
			attacker = scope:attacker
			defender = scope:defender
			claimant = scope:claimant
			victory = no
		}

		# Attacker loses Prestige, all other war participants gain Prestige (Defender gains full prestige, all allies on both sides gain based on war contribution).
		modify_all_participants_fame_values = {
			WINNER = scope:defender
			LOSER = scope:attacker
			FAME_BASE = scope:cb_prestige_factor # Set by 'setup_claim_cb'
			IS_RELIGIOUS_WAR = no
			WINNER_FAME_SCALE = 10
			LOSER_FAME_SCALE = -10
			WINNER_ALLY_FAME_SCALE = 10
			LOSER_ALLY_FAME_SCALE = 10
		}
	
		add_truce_attacker_defeat_effect = yes
		
		scope:attacker = {
			save_temporary_scope_as = loser
		}
		on_lost_aggression_war_discontent_loss = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}
	
	transfer_behavior = transfer
	
	on_primary_attacker_death = inherit
	on_primary_defender_death = inherit
	transfer_behavior = transfer
	
	on_primary_attacker_death = inherit
	on_primary_defender_death = inherit
	
	attacker_allies_inherit = yes
	defender_allies_inherit = yes
	
	interface_priority = 100
	
	use_de_jure_wargoal_only = yes
	
	attacker_wargoal_percentage = 0.8

	on_victory_desc = {
		first_valid = {
			triggered_desc = {
				trigger = { scope:attacker = { is_local_player = yes } }
				desc = gondor_final_battle_war_victory_desc_attacker
			}
			desc = invasion_war_victory_desc
		}
	}
	
	on_victory = {
		# Legitimacy
		add_legitimacy_attacker_victory_effect = yes

		set_global_variable = {
			name = sauron_destroyed
			value = yes
		}
		
		add_to_global_variable_list = {
			name = unavailable_unique_decisions
			target = flag:decision_destroy_mordor
		}
		
		scope:attacker.dynasty = {
			set_variable = this_dynasty_killed_sauron
		}

		every_independent_ruler = {
			limit = {
				exists = var:my_suzerain
				var:my_suzerain = scope:defender
			}
			free_tributary = yes
		}	
		
		scope:attacker = { show_pow_release_message_effect = yes }

		scope:defender = {
			hidden_effect = {
				every_held_title = {
					limit = {
						tier > tier_county
					}
					holder = { # Destroy that title
						destroy_title = prev
					}
				}
				every_held_title = { # Distribute excess non-capital counties to new characters			
					limit = { # For every non-capital county
						tier = tier_county
					}
					set_county_faith = faith:sons_of_sauron
					save_temporary_scope_as = excess_title
	
					create_character = { # Create a new character to hold the title
						employer = root
						culture = culture:burgulhai
						faith = faith:sons_of_sauron
						gender_female_chance = 0
						after_creation = {
							save_temporary_scope_as = new_holder
						}
					}
				
					create_title_and_vassal_change = { # Define type of title change as a granting of the title
						type = granted
						save_scope_as = title_change
						add_claim_on_loss = no
					}
				
					scope:excess_title = { # Set the new character to be the new holder of the title
						change_title_holder = {
							holder = scope:new_holder
							change = scope:title_change
						}
					}
				
					resolve_title_and_vassal_change = scope:title_change # Take a look at yourself, and then make that... change!
					
					# game_rule_create_spouse_and_children = { CHARACTER = scope:new_holder } # Create a family for the new holder
				}
			}
		}
		
		title:c_barad_dur.title_province = {
			remove_building = wonder_baraddur	
		}
		title:k_nurn = {
			if = {
				limit = {
					holder = {
						faith_is_evil = yes
					}
				}
				holder = { # Destroy that title
					destroy_title = prev
				}
			}
		}
		#custom_tooltip = shadow_of_mordor_clears_tt
		#hidden_effect = {
		#	nurnoth_slaves_openly_convert = yes
		#	every_province = {
		#		limit = {
		#			has_holding = yes
		#			OR = {
		#				has_holding_type = wastelands_holding
		#				has_holding_type = settlement_holding
		#				has_holding_type = ruined_holding
		#			}
		#			has_building = shadow_of_mordor
		#			NOT = { geographical_region = middleearth_mordor_gorgoroth }
		#		}
		#		remove_building = shadow_of_mordor
		#	}
		#}
		hidden_effect = {
			nurnoth_slaves_openly_convert = yes
		}
		character:lineofsauron = {
			every_character_artifact = {
				limit = { 
					OR = {
						has_variable = palantir 
						has_variable = relic
					}
				}
				set_owner = {
					target = scope:attacker
					history = {
						type = inherited
						recipient = scope:attacker
					}
				}
			}
			death = { death_reason = death_sauron }
		}
		
		character:mouthofsauron = {
			hidden_effect = {
				every_held_title = {
					limit = {
						tier > tier_county
					}
					holder = { # Destroy that title
						destroy_title = prev
					}
				}
				every_held_title = { # Distribute excess non-capital counties to new characters
				
					limit = { # For every non-capital county
						tier = tier_county
					}
		
					set_county_faith = faith:sons_of_sauron
		
					save_temporary_scope_as = excess_title
		
					create_character = { # Create a new character to hold the title
						employer = root
						culture = culture:burgulhai
						faith = faith:sons_of_sauron
						gender_female_chance = 0
						after_creation = {
							save_temporary_scope_as = new_holder
						}
					}
					
					create_title_and_vassal_change = { # Define type of title change as a granting of the title
						type = granted
						save_scope_as = title_change
						add_claim_on_loss = no
					}
					
					scope:excess_title = { # Set the new character to be the new holder of the title
						change_title_holder = {
							holder = scope:new_holder
							change = scope:title_change
						}
					}
					
					resolve_title_and_vassal_change = scope:title_change # Take a look at yourself, and then make that... change!
		
					# game_rule_create_spouse_and_children = { CHARACTER = scope:new_holder } # Create a family for the new holder
					
				}
			}
			get_title = title:c_barad_dur
		}
		
		#juke note: moved nazgul to scripted effect
		kill_nazgul_effect = yes
		
		scope:attacker = {
			add_prestige = 5000
			every_war_ally = {
				add_prestige = 2000
			}
		}
		
		
		hidden_effect = {
			every_living_character = {
				trigger_event = {
					id = gondor.2103
					#days = 30
				}
			}
			faith:lidless_eye = {
				change_fervor = {
					value = -100
					desc = fervor_dark_lord_defeated
				}
			}
			faith:cult_of_zigur = {
				change_fervor = {
					value = -100
					desc = fervor_dark_lord_defeated
				}
			}
			#faith:red_eye_cult = {	#causes weird heresies like pirate haradwaith
			#	change_fervor = {
			#		value = -30
			#		desc = fervor_dark_lord_defeated
			#	}
			#}
			#faith:faith_haruze = {
			#	change_fervor = {
			#		value = -30
			#		desc = fervor_dark_lord_defeated
			#	}
			#}
			#faith:faith_kerkassk = {
			#	change_fervor = {
			#		value = -30
			#		desc = fervor_dark_lord_defeated
			#	}
			#}
			#faith:faith_khandish_sauronic = {
			#	change_fervor = {
			#		value = -30
			#		desc = fervor_dark_lord_defeated
			#	}
			#}
			
			#juke note: moved religious conversion to a scripted effect
			lidless_eye_destroyed_effect = yes
		}
		
		# Truce
		add_truce_attacker_victory_effect = yes

		# FP1: note the victory for future memorialisation via stele (if applicable).
		scope:attacker = { fp1_remember_recent_conquest_victory_effect = yes }

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}
}